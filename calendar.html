<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MAKA Kalender</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="app-container">
  <header class="header">
    <div class="user-info">
      <h1>ğŸ“… Kalender Sewa</h1>
      <p>Status & aturan pembayaran</p>
    </div>
  </header>

  <section class="info-section" style="padding:16px 18px 8px;">
    <p style="color:var(--text-muted);font-size:.9rem">Klik tanggal untuk lihat / tandai sudah bayar. Tagihan mulai <strong>H+1</strong> setelah ambil motor.</p>
    <div style="margin-top:8px;font-size:.9rem;color:var(--text-muted)">
      <span style="color:var(--primary-neon)">âš« Hari Sewa</span> |
      <span style="color:var(--dp-color)">ğŸŸ£ Cicilan DP</span> |
      <span style="color:var(--danger)">ğŸ”´ Libur</span>
    </div>
  </section>

  <section class="calendar-controls" style="padding:8px 12px 0">
    <div style="display:flex;align-items:center;gap:12px;justify-content:center;">
      <button class="modal-btn btn-ghost" onclick="changeMonth(-1)">â—€</button>
      <h2 id="current-month-year" style="margin:0;color:var(--primary-neon)"></h2>
      <button class="modal-btn btn-ghost" onclick="changeMonth(1)">â–¶</button>
    </div>
  </section>

  <section style="padding:12px">
    <div class="weekdays"><div style="width:14.28%">Min</div><div style="width:14.28%">Sen</div><div style="width:14.28%">Sel</div><div style="width:14.28%">Rab</div><div style="width:14.28%">Kam</div><div style="width:14.28%">Jum</div><div style="width:14.28%">Sab</div></div>
    <div id="calendar-grid" class="calendar-grid"></div>
  </section>

  <footer class="bottom-nav">
    <a href="index.html" class="nav-item"><span>ğŸ </span>Home</a>
    <a href="calendar.html" class="nav-item active"><span>ğŸ“…</span>Kalender</a>
    <a href="daftar_antrian.html" class="nav-item"><span>ğŸ«</span>Antrian</a>
  </footer>
</div>

<!-- Modal tanggal (lihat & bayar) -->
<div id="dateModal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="modal-title">Tanggal</h3>
    <p id="modal-status">Status: ...</p>
    <p id="modal-amount">Jumlah: Rp 0</p>
    <div style="margin-top:12px;text-align:right">
      <button class="modal-btn btn-ghost" onclick="closeDateModal()">Tutup</button>
      <button id="modal-pay-btn" class="modal-btn btn-primary" onclick="confirmPay()">Bayar</button>
    </div>
  </div>
</div>

<script>
/* Calendar logic with rules from your spec.
   - Billing starts H+1 of pickup date.
   - Holidays: 31 always holiday.
   - DP options:
       * 355: next month for 3 months, dates 14 & 28 are CDP (payable) during that period (6 times). After 6 payments, 14 & 28 become holiday.
       * 755: 14 & 28 are holiday from the start.
   - MAKA+ affects daily extra charge (handled in dashboard).
*/

const DEFAULT_PICK = '2025-09-18'; // example pickup (user will set via admin)
const admin = JSON.parse(localStorage.getItem('maka_finance_settings')) || { hwb_rate:80000, cdp_rate:70000 };
const dp_settings = JSON.parse(localStorage.getItem('maka_dp_settings')) || { option:'355' };
const userData = JSON.parse(localStorage.getItem('maka_user_data')) || { name:'M Rizky', plate:'B 4248 SWF', pick_date: DEFAULT_PICK };
const DP_OPTION = dp_settings.option || '355';
const MAKA_PLUS_RATE = 10000;

let currentDate = new Date(); // show current month
let savedPayments = JSON.parse(localStorage.getItem('maka_payments')) || {};
let dp_payments_count = JSON.parse(localStorage.getItem('maka_dp_payments')) || 0;

// helper get DP period (month after pickup, 3 months)
function getDPPeriod(pickDate){
  const pick = new Date(pickDate);
  const start = new Date(pick.getFullYear(), pick.getMonth()+1, 1);
  const end = new Date(start.getFullYear(), start.getMonth()+3, 1); // exclusive
  return { start, end };
}

function getDayStatus(date){
  const d=date.getDate();
  if(d===31) return 'HLB';
  const { start, end } = getDPPeriod(userData.pick_date || DEFAULT_PICK);

  if(DP_OPTION === '355'){
    if(date >= start && date < end){
      if(d===14 || d===28) return 'CDP';
    } else if(date >= end){
      if(d===14 || d===28) return 'HLB';
    }
  } else if (DP_OPTION === '755'){
    if(d===14 || d===28) return 'HLB';
  }
  return 'HWB';
}

// billing starts H+1
function isBeforeBilling(date){
  const pick = new Date(userData.pick_date || DEFAULT_PICK);
  pick.setHours(0,0,0,0);
  const billingStart = new Date(pick);
  billingStart.setDate(pick.getDate()+1);
  billingStart.setHours(0,0,0,0);
  return date < billingStart;
}

function renderCalendar(){
  const grid = document.getElementById('calendar-grid');
  const monthYear = document.getElementById('current-month-year');
  const monthName = currentDate.toLocaleString('id-ID',{ month:'long', year:'numeric' });
  monthYear.textContent = monthName;
  grid.innerHTML='';

  const year = currentDate.getFullYear(), month = currentDate.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();

  // leading empty
  for(let i=0;i<firstDay;i++) grid.innerHTML += '<div class="day empty"></div>';

  for(let d=1; d<=daysInMonth; d++){
    const dt = new Date(year, month, d);
    const key = `${dt.getFullYear()}-${dt.getMonth()+1}-${dt.getDate()}`;
    const status = getDayStatus(dt);
    const isPaid = savedPayments[key] === true;
    const beforeBilling = isBeforeBilling(dt);
    let classes = [];
    if(status==='HLB') classes.push('holiday');
    else if(status==='CDP') classes.push('cicilan-dp');
    else classes.push('wajib-bayar');
    if(isPaid) classes.push('paid');
    if(beforeBilling) classes.push('disabled');

    grid.innerHTML += `<div class="day ${classes.join(' ')}" data-date-key="${key}" data-date="${dt.toISOString()}" onclick="onDayClick(event)">
                         <span class="day-number">${d}</span>
                       </div>`;
  }

  // trailing empty
  const totalCells = firstDay + daysInMonth;
  const remain = (totalCells % 7 ===0) ? 0 : 7 - (totalCells % 7);
  for(let i=0;i<remain;i++) grid.innerHTML += '<div class="day empty"></div>';
}

// when click day
let activeDateKey = null;
function onDayClick(ev){
  const el = ev.currentTarget;
  if(el.classList.contains('empty')) return;
  const key = el.getAttribute('data-date-key');
  const iso = el.getAttribute('data-date');
  const dt = new Date(iso);
  const status = getDayStatus(dt);
  const beforeBilling = isBeforeBilling(dt);
  const isPaid = savedPayments[key] === true;

  // show modal
  const modal = document.getElementById('dateModal');
  document.getElementById('modal-title').textContent = dt.toLocaleDateString('id-ID');
  document.getElementById('modal-status').innerHTML = `Status: <strong>${status}</strong>`;
  // amount
  let amount = 0;
  if(status==='HWB') amount = admin.hwb_rate;
  else if(status==='CDP') amount = admin.cdp_rate;
  else amount = 0;

  // show extra MAKA+ if active and applicable (handled in dashboard summary - optional)
  document.getElementById('modal-amount').textContent = `Jumlah: Rp ${amount.toLocaleString('id-ID')}`;

  const payBtn = document.getElementById('modal-pay-btn');
  activeDateKey = key;

  // if before billing or holiday -> disable pay (unless CDP? spec: holiday not payable)
  if(beforeBilling){
    payBtn.style.display='none';
    document.getElementById('modal-status').innerHTML += '<br><small style="color:var(--text-muted)">Belum mulai tagihan</small>';
  } else if(status==='HLB'){
    payBtn.style.display='none';
    document.getElementById('modal-status').innerHTML += '<br><small style="color:var(--text-muted)">Hari libur</small>';
  } else {
    payBtn.style.display='inline-block';
    payBtn.textContent = isPaid ? 'Batalkan Pembayaran' : `Bayar Rp ${amount.toLocaleString('id-ID')}`;
  }

  modal.classList.add('active');
}

function closeDateModal(){
  document.getElementById('dateModal').classList.remove('active');
  activeDateKey = null;
}

function confirmPay(){
  if(!activeDateKey) return;
  const el = document.querySelector(`[data-date-key="${activeDateKey}"]`);
  const wasPaid = savedPayments[activeDateKey] === true;
  if(wasPaid){
    savedPayments[activeDateKey] = false;
    // if this was a CDP day, reduce dp_payments_count when unpaying
    const dtParts = activeDateKey.split('-').map(Number);
    const dt = new Date(dtParts[0], dtParts[1]-1, dtParts[2]);
    if(getDayStatus(dt) === 'CDP'){
      dp_payments_count = Math.max(0, dp_payments_count - 1);
      localStorage.setItem('maka_dp_payments', JSON.stringify(dp_payments_count));
    }
    el.classList.remove('paid');
  } else {
    savedPayments[activeDateKey] = true;
    // if CDP increment dp counter
    const dtParts = activeDateKey.split('-').map(Number);
    const dt = new Date(dtParts[0], dtParts[1]-1, dtParts[2]);
    if(getDayStatus(dt) === 'CDP'){
      dp_payments_count = (dp_payments_count || 0) + 1;
      localStorage.setItem('maka_dp_payments', JSON.stringify(dp_payments_count));
    }
    el.classList.add('paid');
  }
  localStorage.setItem('maka_payments', JSON.stringify(savedPayments));

  // if dp_payments_count reached 6 and dp option 355 -> mark DP paid (affects future 14/28)
  if(dp_settings.option === '355' && dp_payments_count >= 6){
    localStorage.setItem('maka_dp_paid', JSON.stringify({ paid:true, completed_at:new Date().toISOString() }));
    alert('Cicilan DP terbayar penuh. Tanggal 14 & 28 sekarang menjadi libur.');
  }

  closeDateModal();
  renderCalendar();
}

// month nav
function changeMonth(delta){
  currentDate.setMonth(currentDate.getMonth() + delta);
  renderCalendar();
}

// init
document.addEventListener('DOMContentLoaded', ()=>{
  // reload data
  savedPayments = JSON.parse(localStorage.getItem('maka_payments')) || {};
  dp_payments_count = JSON.parse(localStorage.getItem('maka_dp_payments')) || 0;
  // detect if dp paid earlier and if so adjust dp_settings to treat 14/28 as holiday
  const dpPaidRecord = JSON.parse(localStorage.getItem('maka_dp_paid')) || { paid:false };
  if(dpPaidRecord.paid) {
    // if dp_options was 355 and dp paid -> treat 14/28 as HLB after DP period logic (calendar uses getDayStatus which checks dp_settings)
    // Nothing to change here: getDayStatus will return HLB after DP period OR if dp_paid stored we can override:
    // We store a sentinel to be read by getDayStatus (use localStorage directly in getDayStatus if needed)
  }
  renderCalendar();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MAKA Dashboard ‚Äî Premium</title>

<!-- SINGLE FILE: embedded CSS for ease -->
<style>
  /* ========== THEME (Premium Cyber / Futuristik) ========== */
  :root{
    --bg:#05060a;
    --card: rgba(18,24,40,0.6);
    --glass-border: rgba(255,255,255,0.06);
    --accent: #00eaff;
    --accent-2: #7df3ff;
    --gold: #ffcc55;
    --warn: #ff5c5c;
    --dp-color: #cc99ff;
    --text:#eaf1ff;
    --muted:#94a6bf;
    --nav-h:76px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  html,body{height:100%;margin:0;background:
    radial-gradient(circle at -20% 10%, rgba(0,234,255,0.03), transparent 10%),
    linear-gradient(180deg,#05060a 0%, #020205 100%);
    color:var(--text);-webkit-font-smoothing:antialiased;}
  .app-container{max-width:460px;margin:0 auto;padding-bottom:calc(var(--nav-h) + 18px);min-height:100vh;}
  /* header */
  .header{padding:20px 18px 8px;position:relative;}
  .header .admin-link{position:absolute;right:14px;top:12px;font-size:12px;color:var(--muted);text-decoration:none}
  .user-info h1{font-size:1.35rem;margin:0;color:var(--accent);letter-spacing:.2px;text-shadow:0 0 8px rgba(0,234,255,.08)}
  .user-info p{margin:6px 0 0;font-size:.86rem;color:var(--muted)}
  /* hero card */
  .hero-tunggakan{margin-top:14px;background:linear-gradient(135deg, rgba(0,234,255,.06), rgba(12,16,28,.6));backdrop-filter:blur(10px);padding:14px;border-radius:14px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--glass-border);box-shadow:0 10px 30px rgba(0,234,255,.03)}
  .hero-tunggakan h3{font-size:.78rem;margin:0;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
  .hero-tunggakan p{margin:4px 0 0;font-size:.72rem;color:var(--muted)}
  .hero-tunggakan-value{text-align:right}
  .hero-tunggakan-value .nom{font-size:1.35rem;font-weight:800;color:var(--gold);text-shadow:0 0 8px rgba(255,204,85,.18)}
  .hero-tunggakan-value small{display:block;color:var(--muted);font-size:.78rem;margin-top:4px}
  .futuristic-divider{height:1px;margin:18px 0;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.6}
  /* icon grid */
  .icon-grid-section{padding:0 18px 12px}
  .icon-grid-section h2{font-size:.95rem;margin:0 0 12px;color:var(--accent)}
  .icon-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .icon-item{background:var(--card);padding:14px;border-radius:14px;text-align:center;text-decoration:none;color:var(--text);border:1px solid var(--glass-border);transition:all .22s;position:relative;overflow:hidden}
  .icon-item span{display:block;font-size:1.6rem;margin-bottom:8px}
  .icon-item p{margin:0;font-size:.78rem;color:var(--muted);font-weight:700}
  .icon-item:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,234,255,.08)}
  .sos-card{border:1px solid rgba(255,90,90,.28);box-shadow:0 6px 18px rgba(255,90,90,.06)}
  /* calendar preview card (small) */
  .mini-calendar{margin-top:12px;padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid var(--glass-border)}
  .mini-calendar .line{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .mini-calendar .line strong{color:var(--muted);font-size:.82rem}
  /* bottom nav: larger */
  .bottom-nav{position:fixed;left:0;right:0;bottom:0;height:var(--nav-h);display:flex;justify-content:space-around;align-items:center;background:linear-gradient(to top, rgba(2,6,12,.98), rgba(2,6,12,.85));backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.03);z-index:9999;padding-bottom:env(safe-area-inset-bottom);}
  .bottom-nav a{flex:1;text-align:center;text-decoration:none;color:var(--muted);font-size:12px;font-weight:700;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:10px 4px;height:100%}
  .bottom-nav a span{font-size:20px;line-height:1}
  .bottom-nav a.active{color:var(--accent)}
  .bottom-nav a.active span{filter:drop-shadow(0 0 8px rgba(0,234,255,.6))}
  /* modal */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:10000;padding:20px}
  .modal-overlay.active{display:flex}
  .modal{width:100%;max-width:420px;background:rgba(10,12,18,.95);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,.04);}
  .modal h3{margin:0 0 8px;color:var(--accent)}
  .modal p{margin:0 0 12px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{flex:1;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#001}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--text)}
  .label{font-size:.78rem;color:var(--muted);margin-bottom:6px}
  .muted{color:var(--muted)}
  /* small util */
  .small{font-size:.82rem;color:var(--muted)}
  .mt8{margin-top:8px}
  .text-right{text-align:right}
  /* responsive tweaks */
  @media (max-width:420px){
    .app-container{padding-left:12px;padding-right:12px}
    .icon-item{padding:12px}
  }
</style>
</head>
<body>
<div class="app-container">

  <header class="header">
    <a class="admin-link" href="admin_finance.html">Admin Finance (Sultan)</a>
    <div class="user-info">
      <h1 id="user-name">Halo, User</h1>
      <p>Plat Motor: <strong id="user-plate">-</strong></p>
    </div>

    <div class="hero-tunggakan">
      <div>
        <h3>TOTAL TUNGGAKAN</h3>
        <p class="small">Mulai tagihan H+1 setelah tanggal ambil motor</p>
      </div>
      <div class="hero-tunggakan-value">
        <div class="nom" id="hero-nominal">Rp 0</div>
        <small id="hero-days" class="small">0 Hari Tertunggak</small>
      </div>
    </div>

    <div class="futuristic-divider"></div>
  </header>

  <section class="icon-grid-section">
    <h2>‚ú® Fitur Premium</h2>

    <div class="icon-grid">
      <a class="icon-item" href="calendar.html" id="open-calendar">
        <span>üìÖ</span><p>Bayar & Kalender</p>
      </a>

      <a class="icon-item" href="history.html">
        <span>üóíÔ∏è</span><p>Riwayat</p>
      </a>

      <a class="icon-item" href="part_tracker.html">
        <span>üéÅ</span><p>Gratisan</p>
      </a>

      <a class="icon-item" href="info_mlu.html">
        <span>üì∞</span><p>Info MLU</p>
      </a>

      <a class="icon-item" href="tips_maka.html">
        <span>üí°</span><p>Tips MAKA</p>
      </a>

      <a class="icon-item" href="#" onclick="window.open('https://etle-pmj.info','_blank')">
        <span>üö®</span><p>Cek ETLE</p>
      </a>

      <a class="icon-item" href="settings.html">
        <span>‚öôÔ∏è</span><p>Pengaturan</p>
      </a>

      <a class="icon-item" href="maka_plus.html" id="open-maka-plus">
        <span>‚≠ê</span><p>MAKA+</p>
      </a>

      <a class="icon-item sos-card" href="https://wa.me/62812XXXXXXXX?text=SOS%20MAKA%20Saya%20butuh%20bantuan%20darurat" target="_blank">
        <span>üö®</span><p>SOS Darurat</p>
      </a>
    </div>

    <!-- mini calendar preview -->
    <div class="mini-calendar mt8">
      <div class="line">
        <strong>Kalender Tagihan</strong>
        <a href="calendar.html" class="small muted">Lihat lengkap ‚Üí</a>
      </div>
      <div id="mini-days" class="small muted">Menghitung...</div>
    </div>

  </section>

  <!-- FOOTER NAV -->
  <footer class="bottom-nav" role="navigation">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span><div>Lokasi</div></a>
    <a href="dashboard.html" class="nav-item active"><span>üè†</span><div>Home</div></a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span><div>Antrian</div></a>
  </footer>
</div>

<!-- Modal calendar quick (opened when pressing calendar icon) -->
<div id="calendarModal" class="modal-overlay">
  <div class="modal">
    <h3>Kalender & Pembayaran</h3>
    <p class="muted">Klik tanggal untuk melihat status dan menandai sebagai dibayar.</p>

    <div id="calendarContainer" class="mt8"></div>

    <div class="mt8">
      <div class="label">Keterangan warna:</div>
      <div class="small muted">HWB = Hari Bayar (harian), CDP = Cicilan DP, HLB = Hari Libur</div>
    </div>

    <div class="row mt8">
      <button class="btn ghost" onclick="closeModal('calendarModal')">Tutup</button>
    </div>
  </div>
</div>

<!-- Modal detail day -->
<div id="dayModal" class="modal-overlay">
  <div class="modal">
    <h3 id="dayModalTitle">Tanggal</h3>
    <p id="dayModalStatus" class="muted">Status</p>

    <div id="dayModalBody" class="mt8 small">...</div>

    <div class="row mt8">
      <button id="btnMarkPaid" class="btn primary">Tandai Sudah Bayar</button>
      <button class="btn ghost" onclick="closeModal('dayModal')">Batal</button>
    </div>
  </div>
</div>

<!-- Admin small modal -->
<div id="adminModal" class="modal-overlay">
  <div class="modal">
    <h3>Admin Finance (Sultan) ‚Äî Settings</h3>
    <p class="muted">Ubah setting tarif, opsi DP, atau lihat ringkasan cicilan di sini.</p>

    <div class="mt8">
      <label class="label">Tarif Harian (HWB)</label>
      <input id="admin_hwb" type="number" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:#06101a;color:var(--text)">

      <label class="label mt8">Tarif Cicilan DP (per tgl 14/28)</label>
      <input id="admin_cdp" type="number" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:#06101a;color:var(--text)">

      <label class="label mt8">Opsi DP Default</label>
      <select id="admin_dpopt" style="width:100%;padding:8px;border-radius:8px;background:#06101a;color:var(--text);border:1px solid rgba(255,255,255,.04)">
        <option value="355">DP 355 (cicilan)</option>
        <option value="755">DP 755 (lunas)</option>
      </select>

      <div class="row mt8">
        <button class="btn primary" onclick="saveAdminSettings()">Simpan</button>
        <button class="btn ghost" onclick="closeModal('adminModal')">Batal</button>
      </div>

      <div class="mt8 small muted" id="adminSummary"></div>
    </div>
  </div>
</div>

<script>
/* ===================== DATA DEFAULT / STORAGE KEYS ===================== */
const STORAGE = {
  USER: 'maka_user_data',
  PAYMENTS: 'maka_payments',        // { 'YYYY-MM-DD': {paid:true, type:'HWB'|'CDP'} }
  DP_PAYMENTS: 'maka_dp_payments',  // { 'YYYY-MM-DD': true } (each cicilan)
  FINANCE: 'maka_finance_settings', // { hwb_rate, cdp_rate }
  MAKA_PLUS: 'maka_plus_status'     // { active: true, activated_at: ISOstring }
};

/* ---------- default app data (demo) ---------- */
let userData = JSON.parse(localStorage.getItem(STORAGE.USER)) || {
  name: 'M Rizky Firdaus',
  plate: 'B 4248 SWF',
  tglAmbilMotor: '2025-09-20', // ISO-ish string
  dpOption: '355' // '355' or '755'
};
localStorage.setItem(STORAGE.USER, JSON.stringify(userData));

let finance = JSON.parse(localStorage.getItem(STORAGE.FINANCE)) || { hwb_rate: 80000, cdp_rate: 70000 };
localStorage.setItem(STORAGE.FINANCE, JSON.stringify(finance));

/* ---------- helpers ---------- */
const toKey = d => {
  const y=d.getFullYear(); const m = (d.getMonth()+1); const day=d.getDate();
  return `${y}-${m}-${day}`;
};
const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };

/* ========== RULES: DP scheduling, holidays, start billing ========== */
function getPickupDate(){
  return startOfDay(new Date(userData.tglAmbilMotor));
}
function getBillingStart(){
  const p = getPickupDate();
  p.setDate(p.getDate()+1);
  return startOfDay(p);
}

/* DP installment period: starts month after pickup, on 14 & 28 for 3 months (6 dates) */
function getDpInstallmentDates(){
  const pickup = getPickupDate();
  const startMonth = new Date(pickup.getFullYear(), pickup.getMonth()+1, 1); // first day next month
  const dates = [];
  for(let i=0;i<3;i++){
    const mm = new Date(startMonth.getFullYear(), startMonth.getMonth()+i, 1);
    // 14th
    dates.push(new Date(mm.getFullYear(), mm.getMonth(), 14));
    // 28th
    dates.push(new Date(mm.getFullYear(), mm.getMonth(), 28));
  }
  // sort just in case
  dates.sort((a,b)=>a-b);
  return dates;
}

/* Returns 'HLB' (holiday), 'CDP' (cicilan), 'HWB' (harian) */
function getDayStatus(date){
  const d = startOfDay(date);
  const daynum = d.getDate();

  // 31 always holiday
  if(daynum===31) return 'HLB';

  const billingStart = getBillingStart();
  if(d < billingStart) return 'HLB'; // before billing start -> disabled/holiday

  // If dpOption 755 => 14 & 28 are holiday immediately (plus 31)
  if(userData.dpOption === '755'){
    if(daynum===14 || daynum===28) return 'HLB';
  }

  // If dpOption 355 => during dp installment period 14 & 28 are CDP (payable)
  if(userData.dpOption === '355'){
    const dpDates = getDpInstallmentDates();
    for(const dd of dpDates){
      if(dd.getFullYear()===d.getFullYear() && dd.getMonth()===d.getMonth() && dd.getDate()===d.getDate()){
        // If this dp date already paid (in DP_PAYMENTS), treat as paid (then may be holiday if all done)
        return 'CDP';
      }
    }
  }

  // default: HWB
  return 'HWB';
}

/* Check if all DP installments completed */
function dpInstallmentsPaidCount(){
  const dpPaid = JSON.parse(localStorage.getItem(STORAGE.DP_PAYMENTS)) || {};
  return Object.keys(dpPaid).length;
}
function dpInstallmentsTotalNeeded(){ return 6; }
function dpIsCompleted(){
  return dpInstallmentsPaidCount() >= dpInstallmentsTotalNeeded();
}

/* If after dp completed and dpOption is 355 => 14/28 become holiday */
function effectiveDayStatus(date){
  const base = getDayStatus(date);
  if(userData.dpOption === '355' && dpIsCompleted()){
    // if base was CDP on 14/28 but installments done => HLB
    if(base === 'CDP') return 'HLB';
  }
  return base;
}

/* MAKA+ charge (Rp 10.000/hari) starting day after activation */
function makaPlusChargeForDate(date){
  const mp = JSON.parse(localStorage.getItem(STORAGE.MAKA_PLUS)) || {};
  if(!mp.active) return 0;
  const activated = startOfDay(new Date(mp.activated_at));
  const firstChargeDay = new Date(activated); firstChargeDay.setDate(firstChargeDay.getDate()+1);
  if(date < firstChargeDay) return 0;
  const days = Math.floor( (startOfDay(date) - startOfDay(firstChargeDay)) / (1000*60*60*24) ) + 1;
  return days * 10000;
}

/* ========== CALCULATIONS: outstanding totals from pickup -> today ========== */
function calculateOutstandingUntil(dateTo){
  const finance = JSON.parse(localStorage.getItem(STORAGE.FINANCE)) || { hwb_rate:80000, cdp_rate:70000 };
  const payments = JSON.parse(localStorage.getItem(STORAGE.PAYMENTS)) || {};
  const dpPaidObj = JSON.parse(localStorage.getItem(STORAGE.DP_PAYMENTS)) || {};

  const start = getBillingStart();
  const end = startOfDay(dateTo);
  let total = 0;
  let daysCount = 0;

  let cur = new Date(start);
  while(cur <= end){
    const key = toKey(cur);
    const status = effectiveDayStatus(cur);
    if(status === 'HWB'){
      if(!(payments[key] && payments[key].paid)){
        total += Number(finance.hwb_rate || 0);
        daysCount++;
      }
    } else if(status === 'CDP'){
      // for CDP, check if specific dp payment recorded
      if(!(dpPaidObj[key])){
        total += Number(finance.cdp_rate || 0);
        daysCount++;
      }
    } // HLB nothing
    cur.setDate(cur.getDate()+1);
  }

  // add maka+ daily charge up to dateTo if active
  total += makaPlusChargeForDate(end);

  return { total, days: daysCount };
}

/* ========== RENDER MINI PREVIEW & HERO ========= */
function refreshHero(){
  const now = new Date();
  const res = calculateOutstandingUntil(now);
  document.getElementById('hero-nominal').textContent = `Rp ${res.total.toLocaleString('id-ID')}`;
  document.getElementById('hero-days').textContent = `${res.days} Hari`;
  document.getElementById('mini-days').textContent = `Total tunggakan sampai hari ini: Rp ${res.total.toLocaleString('id-ID')}`;
}

/* ========== CALENDAR UI (full) ========== */
function openCalendarModal(){
  buildCalendarUI();
  document.getElementById('calendarModal').classList.add('active');
}
function closeModal(id){ document.getElementById(id).classList.remove('active'); }

/* Build a simple month calendar (current month default) */
let calendarMonth = new Date(); // will render this month
function buildCalendarUI(){
  const container = document.getElementById('calendarContainer');
  container.innerHTML = ''; // clear

  const header = document.createElement('div');
  header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center'; header.style.marginBottom='8px';

  const prev = document.createElement('button'); prev.className='btn ghost'; prev.textContent='‚óÄ';
  prev.style.padding='8px 10px'; prev.onclick = ()=>{ calendarMonth.setMonth(calendarMonth.getMonth()-1); buildCalendarUI(); };

  const next = document.createElement('button'); next.className='btn ghost'; next.textContent='‚ñ∂';
  next.style.padding='8px 10px'; next.onclick = ()=>{ calendarMonth.setMonth(calendarMonth.getMonth()+1); buildCalendarUI(); };

  const title = document.createElement('div'); title.innerHTML = `<strong>${calendarMonth.toLocaleString('id-ID',{month:'long',year:'numeric'})}</strong>`;

  header.appendChild(prev); header.appendChild(title); header.appendChild(next);
  container.appendChild(header);

  // weekdays
  const wk = document.createElement('div'); wk.style.display='grid'; wk.style.gridTemplateColumns='repeat(7,1fr)'; wk.style.gap='6px'; wk.style.marginBottom='6px';
  ['Min','Sen','Sel','Rab','Kam','Jum','Sab'].forEach(d=>{ const s=document.createElement('div'); s.style.textAlign='center'; s.style.fontSize='12px'; s.style.color='var(--muted)'; s.textContent=d; wk.appendChild(s); });
  container.appendChild(wk);

  // days grid
  const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(7,1fr)'; grid.style.gap='6px';

  const year = calendarMonth.getFullYear(), month = calendarMonth.getMonth();
  const firstDay = new Date(year, month, 1);
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const startOffset = firstDay.getDay();

  // empty slots
  for(let i=0;i<startOffset;i++){
    const empty = document.createElement('div'); empty.style.height='44px'; grid.appendChild(empty);
  }

  // iterate days
  const payments = JSON.parse(localStorage.getItem(STORAGE.PAYMENTS)) || {};
  const dpPaid = JSON.parse(localStorage.getItem(STORAGE.DP_PAYMENTS)) || {};

  for(let d=1; d<=daysInMonth; d++){
    const dt = new Date(year, month, d);
    const key = toKey(dt);
    const baseStatus = getDayStatus(dt);
    const status = effectiveDayStatus(dt);
    const paid = (payments[key] && payments[key].paid) || false;
    const dpPaidForDate = !!dpPaid[key];
    const el = document.createElement('div');
    el.style.height='44px'; el.style.borderRadius='8px'; el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='center';
    el.style.cursor='pointer';
    el.dataset.key = key;

    // styling by status
    if(status==='HLB'){ el.style.background = 'rgba(255,255,255,0.02)'; el.style.border='1px solid rgba(255,80,80,0.08)'; el.style.color='var(--warn)'; }
    else if(status==='CDP'){ el.style.background = dpPaidForDate ? 'rgba(180,180,180,0.08)' : 'rgba(204,153,255,0.06)'; el.style.border='1px solid rgba(204,153,255,0.14)'; el.style.color='var(--dp-color)'; }
    else { el.style.background = paid ? 'linear-gradient(90deg, rgba(255,255,255,0.06), rgba(0,234,255,0.02))' : 'rgba(0,0,0,0.18)'; el.style.border='1px solid rgba(255,255,255,0.03)'; el.style.color='var(--accent)'; }

    if(paid || dpPaidForDate){ el.style.boxShadow='0 8px 20px rgba(0,0,0,.4) inset'; }

    el.innerHTML = `<div style="text-align:center"><div style="font-weight:700">${d}</div><div style="font-size:11px;color:var(--muted)">${status}${(paid||dpPaidForDate) ? ' ‚Ä¢ Lunas':''}</div></div>`;

    // click handler
    el.onclick = ()=>{ openDayDetail(dt, status, paid, dpPaidForDate); };
    grid.appendChild(el);
  }

  // trailing empty
  const totalCells = startOffset + daysInMonth;
  const rem = (totalCells % 7) === 0 ? 0 : 7 - (totalCells % 7);
  for(let i=0;i<rem;i++){ const e=document.createElement('div'); e.style.height='44px'; grid.appendChild(e); }

  container.appendChild(grid);
}

/* Open detail modal for a day */
function openDayDetail(dateObj, status, paid, dpPaidForDate){
  const key = toKey(dateObj);
  const title = document.getElementById('dayModalTitle');
  const st = document.getElementById('dayModalStatus');
  const body = document.getElementById('dayModalBody');
  const btn = document.getElementById('btnMarkPaid');

  title.textContent = dateObj.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
  st.textContent = `Status: ${status}`;
  body.innerHTML = '';

  // compute amount
  const fin = JSON.parse(localStorage.getItem(STORAGE.FINANCE))||{hwb_rate:80000,cdp_rate:70000};
  let amount = 0;
  if(status === 'HWB') amount = fin.hwb_rate || 0;
  else if(status === 'CDP') amount = fin.cdp_rate || 0;
  else amount = 0;

  // add maka+ incremental for that date (not on per-day basis for single-day payment, but show extra if active)
  const makaPlusForDate = makaPlusChargeForDate(dateObj);
  let html = `<div class="small muted">Tipe: <strong>${status}</strong></div>`;
  html += `<div class="small mt8">Jumlah hari ini: <strong>Rp ${amount.toLocaleString('id-ID')}</strong></div>`;
  if(makaPlusForDate>0){
    html += `<div class="small mt8">MAKA+ (akumulasi s/d tgl ini): <strong>Rp ${makaPlusForDate.toLocaleString('id-ID')}</strong></div>`;
  }
  if(status==='HLB'){
    html += `<div class="small mt8 muted">Hari ini adalah libur pembayaran ‚Äî tidak dapat ditandai bayar.</div>`;
    btn.style.display='none';
  } else {
    btn.style.display='inline-block';
    if(status==='CDP' && dpPaidForDate) {
      html += `<div class="small mt8 muted">Cicilan sudah dibayar untuk tanggal ini.</div>`;
      btn.style.display='none';
    } else if(status==='HWB' && paid){
      html += `<div class="small mt8 muted">Sudah bayar hari ini.</div>`;
      btn.style.display='none';
    } else {
      btn.style.display='inline-block';
      btn.onclick = ()=>{ markPaidForDate(key, status); };
    }
  }

  body.innerHTML = html;
  document.getElementById('dayModal').classList.add('active');
}

/* Mark paid */
function markPaidForDate(key, status){
  if(status==='CDP'){
    const dp = JSON.parse(localStorage.getItem(STORAGE.DP_PAYMENTS)) || {};
    dp[key] = true;
    localStorage.setItem(STORAGE.DP_PAYMENTS, JSON.stringify(dp));
  } else if(status==='HWB'){
    const pay = JSON.parse(localStorage.getItem(STORAGE.PAYMENTS)) || {};
    pay[key] = { paid:true, type:'HWB', at: new Date().toISOString() };
    localStorage.setItem(STORAGE.PAYMENTS, JSON.stringify(pay));
  }
  // refresh UI
  buildCalendarUI();
  refreshHero();
  closeModal('dayModal');
}

/* ========== Admin actions (simple) ========== */
function openAdmin(){
  // populate fields
  document.getElementById('admin_hwb').value = (finance.hwb_rate || 80000);
  document.getElementById('admin_cdp').value = (finance.cdp_rate || 70000);
  document.getElementById('admin_dpopt').value = userData.dpOption || '355';
  // show summary
  const dpPaidCount = dpInstallmentsPaidCount();
  document.getElementById('adminSummary').textContent = `Cicilan terbayar: ${dpPaidCount}/${dpInstallmentsTotalNeeded()}`;
  document.getElementById('adminModal').classList.add('active');
}
function saveAdminSettings(){
  const h = Number(document.getElementById('admin_hwb').value||80000);
  const c = Number(document.getElementById('admin_cdp').value||70000);
  finance.hwb_rate = h; finance.cdp_rate = c;
  localStorage.setItem(STORAGE.FINANCE, JSON.stringify(finance));
  // dp option
  userData.dpOption = document.getElementById('admin_dpopt').value;
  localStorage.setItem(STORAGE.USER, JSON.stringify(userData));
  // refresh
  closeModal('adminModal');
  refreshHero();
  alert('Pengaturan tersimpan.');
}

/* ========== MAKA+ small UI (landing) ========== */
function openMakaPlusLanding(){
  // For now open simple modal to activate/deactivate maka+
  const existing = JSON.parse(localStorage.getItem(STORAGE.MAKA_PLUS)) || { active:false };
  const ok = confirm(existing.active ? 'MAKA+ sedang aktif. Batalkan?' : 'Aktifkan MAKA+ (Rp 10.000/hari)?');
  if(ok){
    if(existing.active){
      localStorage.setItem(STORAGE.MAKA_PLUS, JSON.stringify({ active:false }));
      alert('MAKA+ dinonaktifkan.');
    } else {
      const now = new Date();
      localStorage.setItem(STORAGE.MAKA_PLUS, JSON.stringify({ active:true, activated_at: now.toISOString() }));
      alert('MAKA+ aktif mulai hari ini. Biaya akan dihitung mulai H+1.');
    }
    refreshHero();
  }
}

/* ========== INIT & event wiring ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  // read user & finance
  userData = JSON.parse(localStorage.getItem(STORAGE.USER)) || userData;
  finance = JSON.parse(localStorage.getItem(STORAGE.FINANCE)) || finance;

  document.getElementById('user-name').textContent = `Halo, ${userData.name}`;
  document.getElementById('user-plate').textContent = userData.plate;

  // buttons
  document.getElementById('open-calendar').addEventListener('click', openCalendarModal);
  document.getElementById('open-maka-plus').addEventListener('click', (e)=>{ e.preventDefault(); openMakaPlusLanding(); });

  // admin link
  document.querySelector('.admin-link').addEventListener('click', function(e){ e.preventDefault(); openAdmin(); });

  // close click outside modals
  document.querySelectorAll('.modal-overlay').forEach(mo=>{
    mo.addEventListener('click', function(ev){
      if(ev.target === mo) mo.classList.remove('active');
    });
  });

  refreshHero();
});

/* Expose some functions to console for admin/dev */
window._MAKA = { buildCalendarUI, openCalendarModal, refreshHero, getDpInstallmentDates, getBillingStart };
</script>
</body>
</html>

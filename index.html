<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MAKA RTO App</title>

<link rel="stylesheet" href="styles.css">
<script src="app.js"></script>

</head>
<body>

<div id="loginScreen" class="login-screen">
  <div class="card">
    <h1>Login MAKA RTO</h1>

    <label>Nama User</label>
    <input id="nama" type="text" placeholder="Nama lengkap">

    <label>Plat Nomor</label>
    <input id="plat" type="text" placeholder="B 1234 ABC">

    <label>Tanggal Ambil Motor</label>
    <input id="tanggalAmbil" type="date">

    <label>Opsi DP</label>
    <select id="dp">
      <option value="355">DP 355.000 (Cicil)</option>
      <option value="755">DP 755.000 (Langsung)</option>
    </select>

    <button onclick="loginUser()">MASUK</button>
  </div>
</div>

<div id="dashboardScreen" class="app-container" style="display: none;">
  <header class="header">
    <div class="user-info">
      <h1 id="userName">Halo</h1>
      <p>Plat Motor <b id="userPlate"></b></p>
    </div>

    <div class="hero-tunggakan">
      <div>
        <h3>JUMLAH TUNGGAKAN</h3>
        <p class="hero-sub" id="tunggakanDays">0 Hari</p>
      </div>
      <div class="hero-tunggakan-value">
        <span id="billTotal">Rp 0</span>
      </div>
    </div>

    <div class="futuristic-divider"></div>

    <div class="progress-box">
      <div class="progress-label">
        <span id="progressLabel">Progress RTO</span>
        <span id="progressText">0 / 1009 Hari</span>
      </div>
      <div class="progress-bar">
        <div id="progressBarFill"></div>
      </div>
    </div>
  </header>

  <section class="icon-grid-section">
    <h3 class="section-title">‚ú® Fitur</h3>
    <div class="icon-grid">
      <a href="#" class="icon-item" onclick="showScreen('calendar')"><span>üìÖ</span><p>Kalender</p></a>
      <a href="#" class="icon-item" onclick="showScreen('history')"><span>üßæ</span><p>Riwayat</p></a>
      <a href="#" class="icon-item"><span>üéÅ</span><p>Part Gratis</p></a>
      <a href="#" class="icon-item"><span>üì∞</span><p>Info MLU</p></a>
      <a href="#" class="icon-item"><span>üí°</span><p>Maka Tips</p></a>
      <a href="#" class="icon-item"><span>‚≠ê</span><p>MAKA+</p></a>
      <a href="#" class="icon-item"><span>‚öôÔ∏è</span><p>Setting</p></a>
      <a href="https://wa.me/62812XXXXXXX" target="_blank" class="icon-item sos-card"><span>üö®</span><p>SOS CS</p></a>
    </div>
  </section>
</div>

<div id="calendarScreen" class="app-container" style="display: none;">
    <h3 class="header-title" style="padding: 22px 22px 0;">üìÖ Kalender Pembayaran</h3>
    <div class="cal-header">
        <span style="color: var(--holiday-color);">Min</span>
        <span>Sen</span>
        <span>Sel</span>
        <span>Rab</span>
        <span>Kam</span>
        <span>Jum</span>
        <span>Sab</span>
    </div>
    <div class="cal-grid" id="calendar"></div>
</div>

<div id="historyScreen" class="app-container" style="display: none;">
    <h3 class="header-title" style="padding: 22px 22px 0;">üßæ Riwayat Pembayaran</h3>
    <div class="card">
        <p style="font-weight: 600; font-size: 0.9em; margin-bottom: 10px;">Log Transaksi</p>
        <ul id="paymentHistoryList" style="list-style: none; padding: 0;"></ul>
    </div>
</div>


<footer id="bottomNav" class="bottom-nav" style="display: none;">
  <a href="#" class="nav-item" onclick="showScreen('fc')"><span>‚ö°</span>FC</a>
  <a href="#" class="nav-item active" id="navHome" onclick="showScreen('dashboard')"><span>üè†</span>Home</a>
  <a href="#" class="nav-item" id="navCalendar" onclick="showScreen('calendar')"><span>üìÖ</span>Bayar</a>
</footer>

<script>
/* ========================================================== */
/* JAVASCRIPT GLOBAL SCRIPT (Dari index.html sebelumnya)      */
/* ========================================================== */

// --- GLOBAL NAVIGATION ---
function showScreen(screenId) {
    const screens = ['loginScreen', 'dashboardScreen', 'calendarScreen', 'historyScreen'];
    screens.forEach(id => {
        document.getElementById(id).style.display = (id === screenId + 'Screen' || id === 'loginScreen' && screenId === 'login') ? 'block' : 'none';
    });

    const user = getActiveUser();
    document.getElementById('bottomNav').style.display = (user && screenId !== 'login') ? 'flex' : 'none';
    
    // Aktifkan Nav Item yang benar
    const navItems = document.querySelectorAll('.bottom-nav .nav-item');
    navItems.forEach(item => item.classList.remove('active'));
    
    if (screenId === 'dashboard') {
        document.getElementById('navHome').classList.add('active');
        renderDashboard();
    } else if (screenId === 'calendar') {
        document.getElementById('navCalendar').classList.add('active');
        renderCalendar(); 
    } else if (screenId === 'history') {
        renderHistory();
    }
}

// --- LOGIN/SIGNUP LOGIC ---
function loginUser(){
  const nama = document.getElementById('nama').value.trim();
  const plat = document.getElementById('plat').value.trim();
  const tanggalAmbil = document.getElementById('tanggalAmbil').value;
  const dp = document.getElementById('dp').value;

  if(!nama || !plat || !tanggalAmbil){
    alert('Lengkapi semua data');
    return;
  }

  // Cek apakah user sudah ada (sederhana)
  let user = DB.users.find(u => u.plat === plat);
  if (user) {
    DB.activeUserId = user.id;
  } else {
    const newUser = {
      id: 'USR' + Date.now(), 
      nama: nama, plat: plat, startDate: tanggalAmbil, dpType: dp, 
      progressHari: 0, makaPlus: { active: false, activatedAt: null }, payments: {}, freeParts: []
    };
    DB.users.push(newUser);
    DB.activeUserId = newUser.id;
  }

  saveDB(DB);
  showScreen('dashboard');
}

// --- RENDER FUNCTIONS (Pastikan sudah didefinisikan di app.js) ---
function renderDashboard(){
    const user = getActiveUser();
    if (!user) return;

    const totalDays = DB.config.totalRentalDays;
    const tunggakanData = getTotalTunggakan(user);
    const progressPercent = (user.progressHari / totalDays) * 100;

    document.getElementById('userName').textContent = 'Halo, ' + user.nama;
    document.getElementById('userPlate').textContent = user.plat;

    // TUNGGAKAN
    const tunggakanSpan = document.getElementById('billTotal');
    const daysP = document.getElementById('tunggakanDays');

    document.getElementById('billTotal').textContent = formatIDR(tunggakanData.nominal);
    document.getElementById('tunggakanDays').textContent = tunggakanData.hari + ' Hari Tertunggak';
    
    // Menggunakan CSS Variable dari styles.css
    if(tunggakanData.hari > 0) {
        tunggakanSpan.style.color = 'var(--holiday-color)'; // Merah
        daysP.style.color = 'var(--holiday-color)'; 
    } else {
        tunggakanSpan.style.color = 'var(--paid-green)'; // Hijau
        daysP.style.color = 'var(--paid-green)';
    }

    // PROGRESS BAR
    document.getElementById('progressText').textContent = user.progressHari + ' / ' + totalDays + ' Hari';
    document.getElementById('progressBarFill').style.width = progressPercent.toFixed(2) + '%';
}

function renderCalendar(){
    const user = getActiveUser();
    if(!user) return;
    
    const cal = document.getElementById('calendar');
    cal.innerHTML = ''; 
    
    const now = new Date();
    now.setHours(0,0,0,0);
    const y = now.getFullYear();
    const m = now.getMonth();

    const daysInMonth = new Date(y, m+1, 0).getDate();
    const firstDayOfMonth = new Date(y, m, 1).getDay();

    // Kotak kosong untuk offset hari
    for(let i=0; i<firstDayOfMonth; i++){
        const emptyBox = document.createElement('div');
        emptyBox.className = 'day-box';
        emptyBox.innerHTML = '&nbsp;';
        emptyBox.style.border = 'none';
        emptyBox.style.background = 'transparent';
        emptyBox.style.boxShadow = 'none';
        cal.appendChild(emptyBox);
    }

    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(y,m,d);
      date.setHours(0,0,0,0);
      const iso = dateOnly(date);

      const box = document.createElement('div');
      box.className = 'day-box';
      box.innerHTML = `<b>${d}</b>`;

      if(date.getTime() === now.getTime()) box.classList.add('today-day');

      const isPaid = user.payments[iso]?.paid;
      const dpStatus = getDPCicilStatus(user, iso); 

      if(isPaid){
        box.classList.add('paid-day');
        box.innerHTML += `<small>Bayar</small>`;
      }
      else if(isHoliday(user, iso)){
        box.classList.add('holiday-day');
        box.innerHTML += `<small>Libur</small>`;
      }
      else if(dpStatus.isCicilDay){
        box.classList.add('dp-day');
        box.innerHTML += `<small>Cicil DP</small>`;
        box.onclick = ()=> confirmPay(iso, getDailyRate(user, iso)); 
      }
      else{
        const rate = getDailyRate(user, iso);
        box.innerHTML += `<small>${formatIDR(rate)}</small>`;
        
        if (date.getTime() <= now.getTime()) {
            box.onclick = ()=> confirmPay(iso, rate);
        }
        
        if (date.getTime() === now.getTime() && rate > 0) {
            box.style.color = 'var(--holiday-color)'; 
        }
      }
      cal.appendChild(box);
    }
}

function confirmPay(date, amount){
  if(amount === 0) return; 

  if(confirm(`Bayar tanggal ${date}\nTagihan: ${formatIDR(amount)}`)){
    markPaid(getActiveUser(), date); 
    alert('‚úÖ Dicatat sebagai dibayar');
    renderCalendar();
    renderDashboard();
  }
}

function renderHistory() {
    const user = getActiveUser();
    const list = document.getElementById('paymentHistoryList');
    list.innerHTML = '';
    
    const historyArray = Object.keys(user.payments).map(date => ({
        date: date,
        ...user.payments[date]
    })).sort((a, b) => new Date(b.date) - new Date(a.date));

    if (historyArray.length === 0) {
        list.innerHTML = '<li style="padding: 10px 0; color: var(--text-secondary);">Belum ada riwayat pembayaran.</li>';
        return;
    }

    historyArray.forEach(item => {
        const li = document.createElement('li');
        li.style.padding = '10px 0';
        li.style.borderBottom = '1px solid var(--glass-border)';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        
        li.innerHTML = `
            <div>
                <b style="font-size: 0.9em;">${item.date}</b><br>
                <small style="color: var(--text-secondary);">${item.type === 'cicil_dp' ? 'Cicilan DP' : 'Sewa Harian'}</small>
            </div>
            <div style="text-align: right;">
                <span style="font-weight: 600; color: var(--paid-green);">${formatIDR(item.amount)}</span>
            </div>
        `;
        list.appendChild(li);
    });
}


/* INITIAL CHECK */
document.addEventListener('DOMContentLoaded', () => {
    const user = getActiveUser();
    if (user) {
        renderDashboard();
        showScreen('dashboard');
    } else {
        showScreen('login');
    }
});
</script>
</body>
</html>
